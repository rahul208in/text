#!/bin/bash

# Function to create JSON environment entries for ENVIRONMENT variable
create_env_json() {
  local envs=(${1//,/ })  # Split environments by commas
  local env_json=""
  
  for env in "${envs[@]}"; do
    env_json="${env_json}{
      \"ref\": \"env\":\"${env}\",
      \"type\":\"environment\"
    },"
  done

  # Remove the last comma and return the JSON block
  echo "${env_json%,}"
}

# Input file name
input_file="input.txt"

# Initialize a variable to hold the JSON output
json_output="{"

# Read the input file and process each key-value pair
while IFS='=' read -r key value; do
  # If the key is ENVIRONMENT, handle it differently
  if [ "$key" == "ENVIRONMENT" ]; then
    env_json=$(create_env_json "$value")
    json_output="${json_output}\"env\": [ $env_json ],"
  else
    # Otherwise, add the key-value pair normally
    json_output="${json_output}\"$key\": \"$value\","
  fi
done < "$input_file"

# Remove the last comma and close the JSON block
json_output="${json_output%,}}"

# Output the JSON to a file
output_file="output.json"
echo "$json_output" > "$output_file"

echo "Generated JSON saved to $output_file"
