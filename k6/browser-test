import { chromium } from 'k6/x/browser';
import { sleep } from 'k6';

export const options = {
  scenarios: {
    browser: {
      executor: 'constant-vus',
      vus: 1,
      duration: '30s',
      options: {
        browser: {
          type: 'chromium',
        },
      },
    },
  },
};

export default function () {
  const browser = chromium.launch({ headless: true });
  const context = browser.newContext();
  const page = context.newPage();

  try {
    // 1️⃣ Open Page 1
    page.goto('https://example.com/page1', { waitUntil: 'networkidle' });

    // 2️⃣ Extract token from Page 1 (hidden input or text using JS)
    // Example: <input type="hidden" id="authToken" value="12345">
    const token = page.$eval('#authToken', (el) => el.value);
    console.log(`Token extracted from Page 1: ${token}`);

    // (Alternative if token appears in page text)
    // const token = page.evaluate(() =>
    //   document.body.innerText.match(/token=([a-zA-Z0-9]+)/)?.[1]
    // );

    // 3️⃣ Navigate to Page 2
    page.goto('https://example.com/page2', { waitUntil: 'networkidle' });

    // 4️⃣ Inject token on Page 2 (form field or API call)
    await page.fill('#tokenField', token); // assuming there is an input with id 'tokenField'
    await page.click('#submitButton');

    // Wait for result
    page.waitForSelector('#successMessage');
    console.log('Token submitted successfully on Page 2');

    sleep(1);
  } finally {
    page.close();
    context.close();
    browser.close();
  }
}
