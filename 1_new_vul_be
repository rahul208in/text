

import formidable from 'formidable';
import fs from 'fs/promises';
import { parse } from 'json2csv';

export const config = {
  api: {
    bodyParser: false,
  },
};

export async function POST(req) {
  try {
    // Step 1: Parse form data
    const form = new formidable.IncomingForm();
    const { fields, files } = await new Promise((resolve, reject) => {
      form.parse(req, (err, fields, files) => {
        if (err) {
          console.error('Error parsing form data:', err);
          reject(err);
        } else {
          console.log('Parsed fields:', fields);
          console.log('Parsed files:', files);
          resolve({ fields, files });
        }
      });
    });

    // Step 2: Validate inputs
    const param1 = fields.param1;
    const param2 = fields.param2;
    if (!param1 || !param2) {
      throw new Error('Missing required parameters: param1 or param2');
    }

    if (!files.file) {
      throw new Error('Uploaded file is missing');
    }

    // Step 3: Read and parse the uploaded JSON file
    console.log('Reading file:', files.file.filepath);
    const fileContent = await fs.readFile(files.file.filepath, 'utf-8');
    const jsonData = JSON.parse(fileContent);
    console.log('Parsed JSON data:', jsonData);

    const vulnerabilities = jsonData.vulnerabilities || [];

    // Step 4: Transform data into CSV
    const csvData = vulnerabilities.map((vuln) => ({
      CVE: vuln.identifiers?.CVE?.[0] || '',
      'REPO URL': param1,
      PACKAGE: vuln.packageName,
      'PACKAGE VERSION': vuln.version,
      SEVERITY: vuln.severity,
      score: vuln.cvssScore || '',
      'has fixed': vuln.fixedIn?.length > 0 ? 'y' : 'n',
      'fixed version': vuln.fixedIn?.[0] || '',
      description: `${vuln.id}: ${vuln.description}`,
      'repo name': param2,
      sha256: 'commit',
      branch: 'main',
    }));

    console.log('CSV Data:', csvData);

    const csv = parse(csvData, {
      fields: [
        'CVE',
        'REPO URL',
        'PACKAGE',
        'PACKAGE VERSION',
        'SEVERITY',
        'score',
        'has fixed',
        'fixed version',
        'description',
        'repo name',
        'sha256',
        'branch',
      ],
    });

    // Step 5: Return the CSV as a response
    return new Response(csv, {
      headers: {
        'Content-Type': 'text/csv',
        'Content-Disposition': 'attachment; filename=vulnerabilities.csv',
      },
    });
  } catch (error) {
    console.error('Error processing request:', error);
    return new Response(
      JSON.stringify({ error: error.message || 'Internal Server Error' }),
      {
        status: 500,
        headers: { 'Content-Type': 'application/json' },
      }
    );
  }
}
